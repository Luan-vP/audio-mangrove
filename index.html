<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TechnoShamanism Tree Growth</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
</head>
<body>
<script>
  let mic, fft;
  let tree = [];
  let baseThreshold = 200; // Hz, define low-frequency threshold

  function setup() {
    createCanvas(windowWidth, windowHeight);
    background(0);
    
    // Create but don't start the audio input yet
    mic = new p5.AudioIn();
    fft = new p5.FFT(0.8, 64);
    
    // Add a start button
    let startButton = createButton('Start Audio');
    startButton.position(10, 10);
    startButton.mousePressed(startAudio);

    textAlign(CENTER, CENTER);
    fill(255);
    textSize(16);
    text('Click "Start Audio" and allow microphone access to begin', width/2, height/2);
  }

  function startAudio() {
    userStartAudio();
    mic.start();
    fft.setInput(mic);
  }

  function draw() {
    background(0, 50);
    
    if (mic && mic.enabled) {
      let spectrum = fft.analyze();
      let lowFreqEnergy = fft.getEnergy("bass");
      let highFreqEnergy = fft.getEnergy("treble");

      // Display the energy levels for debugging
      displayEnergyLevels(lowFreqEnergy, highFreqEnergy);

      // Grow roots if bass is strong
      if (lowFreqEnergy > 100) {
        growRoots();
      }

      // Grow branches and flowers if treble is strong
      if (highFreqEnergy > 100) {
        growBranches();
        if (random(1) < 0.1) {
          growFlowers();
        }
      }
    }

    // Draw the tree
    drawTree();
  }

  function displayEnergyLevels(lowFreqEnergy, highFreqEnergy) {
    fill(255);
    noStroke();
    textSize(16);
    text("Bass Energy: " + lowFreqEnergy, 10, height - 30);
    text("Treble Energy: " + highFreqEnergy, 10, height - 10);
  }

  function growRoots() {
    let root = {
      x: width / 2,
      y: height,
      length: random(10, 20),
      angle: PI/2 + random(-QUARTER_PI, QUARTER_PI)
    };
    tree.push(root);
  }

  function growBranches() {
    let branches = tree.filter(part => part.length < 50);
    branches.forEach(branch => {
      let newBranch = {
        x: branch.x,
        y: branch.y,
        length: branch.length * 0.7,
        angle: branch.angle + random(-QUARTER_PI, QUARTER_PI)
      };
      tree.push(newBranch);
    });
  }

  function growFlowers() {
    let flowers = tree.filter(part => part.length < 20);
    flowers.forEach(flower => {
      let newFlower = {
        x: flower.x + cos(flower.angle) * flower.length,
        y: flower.y + sin(flower.angle) * flower.length,
        size: random(2, 5),
        color: color(random(255), random(255), random(255))
      };
      tree.push(newFlower);
    });
  }

  function drawTree() {
    stroke(255);
    tree.forEach(part => {
      if (part.length) {
        let endX = part.x + cos(part.angle) * part.length;
        let endY = part.y + sin(part.angle) * part.length;
        line(part.x, part.y, endX, endY);
        part.length *= 0.99; // Slow down the shrinking
      } else {
        noStroke();
        fill(part.color);
        ellipse(part.x, part.y, part.size);
      }
    });
  }
</script>
</body>
</html>
